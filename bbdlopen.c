#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <dlfcn.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <time.h>

#define BBDLOPEN "bbdlopen"

#ifdef DEBUG
#include <android/log.h>
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, BBDLOPEN, __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#elif PRINT
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, BBDLOPEN, __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#else
#define LOGV(...)
#endif

//reduce binary size
char __aeabi_unwind_cpp_pr0[0];

typedef int lbb_main_t(char ** con);

//#define MYLIB "/data/local/tmp/cm/libbusybox.so"
#define MYLIB "/system/lib/libpdfium.so"
#define MYSYMBOL "lbb_main"

int main(int argc, char **argv)
{
    char **myargs;
    if (argc>=2 && strcmp(argv[1], "--zpi") == 0) {
        myargs = &argv[2];
    } else {
        myargs = argv;
    }
    //LOGV("Loading %s", MYLIB);
    void *bbshared = dlopen(MYLIB, RTLD_LAZY);
    if (bbshared) {
        void *bbmain = dlsym(bbshared, MYSYMBOL);
        if (bbmain) {
            lbb_main_t *lbb_main_p = (lbb_main_t *) bbmain;
            int ret = (*lbb_main_p)(myargs);
            LOGV("ret = %d", ret);
        } else {
            const char *error = dlerror();
            LOGV("dlsym error %s", error);
        }
        dlclose(bbshared);
    } else {
        const char *error = dlerror();
        LOGV("Loading of %s failed %s", MYLIB, error);
    }
    return 0;
}

